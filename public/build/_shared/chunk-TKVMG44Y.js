import{d as Pe,g as Ie,i as d}from"/build/_shared/chunk-4JAR5RLY.js";d();var p=Pe(Ie());d();var re="app-basket";async function ne(){try{let e=await localStorage.getItem(re);if(e)return JSON.parse(e)}catch{}return{}}function ae(e){try{return localStorage.setItem(re,JSON.stringify(e))}catch{}}d();d();function b(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(!1)var a,o;throw Error("[Immer] minified error nr: "+e+(r.length?" "+r.map(function(i){return"'"+i+"'"}).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function E(e){return!!e&&!!e[v]}function P(e){return!!e&&(function(t){if(!t||typeof t!="object")return!1;var r=Object.getPrototypeOf(t);if(r===null)return!0;var n=Object.hasOwnProperty.call(r,"constructor")&&r.constructor;return n===Object||typeof n=="function"&&Function.toString.call(n)===xe}(e)||Array.isArray(e)||!!e[pe]||!!e.constructor[pe]||W(e)||L(e))}function _(e,t,r){r===void 0&&(r=!1),j(e)===0?(r?Object.keys:Z)(e).forEach(function(n){r&&typeof n=="symbol"||t(n,e[n],e)}):e.forEach(function(n,a){return t(a,n,e)})}function j(e){var t=e[v];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:W(e)?2:L(e)?3:0}function q(e,t){return j(e)===2?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Ae(e,t){return j(e)===2?e.get(t):e[t]}function he(e,t,r){var n=j(e);n===2?e.set(t,r):n===3?(e.delete(t),e.add(r)):e[t]=r}function Ee(e,t){return e===t?e!==0||1/e==1/t:e!=e&&t!=t}function W(e){return Be&&e instanceof Map}function L(e){return _e&&e instanceof Set}function w(e){return e.o||e.t}function Q(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=Ce(e);delete t[v];for(var r=Z(t),n=0;n<r.length;n++){var a=r[n],o=t[a];o.writable===!1&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(t[a]={configurable:!0,writable:!0,enumerable:o.enumerable,value:e[a]})}return Object.create(Object.getPrototypeOf(e),t)}function Y(e,t){return t===void 0&&(t=!1),G(e)||E(e)||!P(e)||(j(e)>1&&(e.set=e.add=e.clear=e.delete=je),Object.freeze(e),t&&_(e,function(r,n){return Y(n,!0)},!0)),e}function je(){b(2)}function G(e){return e==null||typeof e!="object"||Object.isFrozen(e)}function k(e){var t=Ne[e];return t||b(18,e),t}function oe(){return x}function M(e,t){t&&(k("Patches"),e.u=[],e.s=[],e.v=t)}function N(e){K(e),e.p.forEach(Se),e.p=null}function K(e){e===x&&(x=e.l)}function ie(e){return x={p:[],l:x,h:e,m:!0,_:0}}function Se(e){var t=e[v];t.i===0||t.i===1?t.j():t.O=!0}function F(e,t){t._=t.p.length;var r=t.p[0],n=e!==void 0&&e!==r;return t.h.g||k("ES5").S(t,e,n),n?(r[v].P&&(N(t),b(4)),P(e)&&(e=T(t,e),t.l||z(t,e)),t.u&&k("Patches").M(r[v].t,e,t.u,t.s)):e=T(t,r,[]),N(t),t.u&&t.v(t.u,t.s),e!==de?e:void 0}function T(e,t,r){if(G(t))return t;var n=t[v];if(!n)return _(t,function(o,i){return ue(e,n,t,o,i,r)},!0),t;if(n.A!==e)return t;if(!n.P)return z(e,n.t,!0),n.t;if(!n.I){n.I=!0,n.A._--;var a=n.i===4||n.i===5?n.o=Q(n.k):n.o;_(n.i===3?new Set(a):a,function(o,i){return ue(e,n,a,o,i,r)}),z(e,a,!1),r&&e.u&&k("Patches").R(n,r,e.u,e.s)}return n.o}function ue(e,t,r,n,a,o){if(E(a)){var i=T(e,a,o&&t&&t.i!==3&&!q(t.D,n)?o.concat(n):void 0);if(he(r,n,i),!E(i))return;e.m=!1}if(P(a)&&!G(a)){if(!e.h.F&&e._<1)return;T(e,a),t&&t.A.l||z(e,a)}}function z(e,t,r){r===void 0&&(r=!1),e.h.F&&e.m&&Y(t,r)}function V(e,t){var r=e[v];return(r?w(r):e)[t]}function ce(e,t){if(t in e)for(var r=Object.getPrototypeOf(e);r;){var n=Object.getOwnPropertyDescriptor(r,t);if(n)return n;r=Object.getPrototypeOf(r)}}function U(e){e.P||(e.P=!0,e.l&&U(e.l))}function R(e){e.o||(e.o=Q(e.t))}function J(e,t,r){var n=W(t)?k("MapSet").N(t,r):L(t)?k("MapSet").T(t,r):e.g?function(a,o){var i=Array.isArray(a),l={i:i?1:0,A:o?o.A:oe(),P:!1,I:!1,D:{},l:o,t:a,k:null,o:null,j:null,C:!1},u=l,c=$;i&&(u=[l],c=B);var f=Proxy.revocable(u,c),g=f.revoke,m=f.proxy;return l.k=m,l.j=g,m}(t,r):k("ES5").J(t,r);return(r?r.A:oe()).p.push(n),n}function De(e){return E(e)||b(22,e),function t(r){if(!P(r))return r;var n,a=r[v],o=j(r);if(a){if(!a.P&&(a.i<4||!k("ES5").K(a)))return a.t;a.I=!0,n=se(r,o),a.I=!1}else n=se(r,o);return _(n,function(i,l){a&&Ae(a.t,i)===l||he(n,i,t(l))}),o===3?new Set(n):n}(e)}function se(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return Q(e)}var le,x,X=typeof Symbol<"u"&&typeof Symbol("x")=="symbol",Be=typeof Map<"u",_e=typeof Set<"u",fe=typeof Proxy<"u"&&Proxy.revocable!==void 0&&typeof Reflect<"u",de=X?Symbol.for("immer-nothing"):((le={})["immer-nothing"]=!0,le),pe=X?Symbol.for("immer-draftable"):"__$immer_draftable",v=X?Symbol.for("immer-state"):"__$immer_state",Ve=typeof Symbol<"u"&&Symbol.iterator||"@@iterator";var xe=""+Object.prototype.constructor,Z=typeof Reflect<"u"&&Reflect.ownKeys?Reflect.ownKeys:Object.getOwnPropertySymbols!==void 0?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,Ce=Object.getOwnPropertyDescriptors||function(e){var t={};return Z(e).forEach(function(r){t[r]=Object.getOwnPropertyDescriptor(e,r)}),t},Ne={},$={get:function(e,t){if(t===v)return e;var r=w(e);if(!q(r,t))return function(a,o,i){var l,u=ce(o,i);return u?"value"in u?u.value:(l=u.get)===null||l===void 0?void 0:l.call(a.k):void 0}(e,r,t);var n=r[t];return e.I||!P(n)?n:n===V(e.t,t)?(R(e),e.o[t]=J(e.A.h,n,e)):n},has:function(e,t){return t in w(e)},ownKeys:function(e){return Reflect.ownKeys(w(e))},set:function(e,t,r){var n=ce(w(e),t);if(n==null?void 0:n.set)return n.set.call(e.k,r),!0;if(!e.P){var a=V(w(e),t),o=a==null?void 0:a[v];if(o&&o.t===r)return e.o[t]=r,e.D[t]=!1,!0;if(Ee(r,a)&&(r!==void 0||q(e.t,t)))return!0;R(e),U(e)}return e.o[t]===r&&typeof r!="number"&&(r!==void 0||t in e.o)||(e.o[t]=r,e.D[t]=!0,!0)},deleteProperty:function(e,t){return V(e.t,t)!==void 0||t in e.t?(e.D[t]=!1,R(e),U(e)):delete e.D[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var r=w(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n&&{writable:!0,configurable:e.i!==1||t!=="length",enumerable:n.enumerable,value:r[t]}},defineProperty:function(){b(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){b(12)}},B={};_($,function(e,t){B[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),B.deleteProperty=function(e,t){return B.set.call(this,e,t,void 0)},B.set=function(e,t,r){return $.set.call(this,e[0],t,r,e[0])};var Te=function(){function e(r){var n=this;this.g=fe,this.F=!0,this.produce=function(a,o,i){if(typeof a=="function"&&typeof o!="function"){var l=o;o=a;var u=n;return function(h){var A=this;h===void 0&&(h=l);for(var O=arguments.length,ee=Array(O>1?O-1:0),C=1;C<O;C++)ee[C-1]=arguments[C];return u.produce(h,function(we){var te;return(te=o).call.apply(te,[A,we].concat(ee))})}}var c;if(typeof o!="function"&&b(6),i!==void 0&&typeof i!="function"&&b(7),P(a)){var f=ie(n),g=J(n,a,void 0),m=!0;try{c=o(g),m=!1}finally{m?N(f):K(f)}return typeof Promise<"u"&&c instanceof Promise?c.then(function(h){return M(f,i),F(h,f)},function(h){throw N(f),h}):(M(f,i),F(c,f))}if(!a||typeof a!="object"){if((c=o(a))===void 0&&(c=a),c===de&&(c=void 0),n.F&&Y(c,!0),i){var I=[],s=[];k("Patches").M(a,c,I,s),i(I,s)}return c}b(21,a)},this.produceWithPatches=function(a,o){if(typeof a=="function")return function(c){for(var f=arguments.length,g=Array(f>1?f-1:0),m=1;m<f;m++)g[m-1]=arguments[m];return n.produceWithPatches(c,function(I){return a.apply(void 0,[I].concat(g))})};var i,l,u=n.produce(a,o,function(c,f){i=c,l=f});return typeof Promise<"u"&&u instanceof Promise?u.then(function(c){return[c,i,l]}):[u,i,l]},typeof(r==null?void 0:r.useProxies)=="boolean"&&this.setUseProxies(r.useProxies),typeof(r==null?void 0:r.autoFreeze)=="boolean"&&this.setAutoFreeze(r.autoFreeze)}var t=e.prototype;return t.createDraft=function(r){P(r)||b(8),E(r)&&(r=De(r));var n=ie(this),a=J(this,r,void 0);return a[v].C=!0,K(n),a},t.finishDraft=function(r,n){var a=r&&r[v],o=a.A;return M(o,n),F(void 0,o)},t.setAutoFreeze=function(r){this.F=r},t.setUseProxies=function(r){r&&!fe&&b(20),this.g=r},t.applyPatches=function(r,n){var a;for(a=n.length-1;a>=0;a--){var o=n[a];if(o.path.length===0&&o.op==="replace"){r=o.value;break}}a>-1&&(n=n.slice(a+1));var i=k("Patches").$;return E(r)?i(r,n):this.produce(r,function(l){return i(l,n)})},e}(),y=new Te,ze=y.produce,Re=y.produceWithPatches.bind(y),qe=y.setAutoFreeze.bind(y),Ke=y.setUseProxies.bind(y),Ue=y.applyPatches.bind(y),Je=y.createDraft.bind(y),$e=y.finishDraft.bind(y),ve=ze;var S={status:"not-hydrated",clientBasket:{cart:[],voucherCode:null,crystallizeOrderId:null,klarnaOrderId:null},serverBasket:null,attentionCartItem:{}},ye=ve(function(t,{action:r,...n}){switch(t.changeTriggeredByOtherTab=!1,r){case"hydrate":{t.status==="not-hydrated"&&(n.cart&&(t.clientBasket=n||S.clientBasket,t.clientBasket.cart||(t.clientBasket.cart=S.clientBasket.cart)),t.status="server-basket-is-stale");break}case"channel-update":{t.clientBasket=n.clientBasket,t.serverBasket=n.serverBasket,t.changeTriggeredByOtherTab=!0,t.status="ready";break}case"set-crystallize-order-id":{t.clientBasket.crystallizeOrderId=n.crystallizeOrderId;break}case"set-klarna-order-id":{t.clientBasket.klarnaOrderId=n.klarnaOrderId;break}case"server-update-failed":{t.status="server-update-failed";break}case"retry-server-update":{t.status="server-basket-is-stale";break}case"empty":{t.clientBasket=S.clientBasket,t.status="server-basket-is-stale";break}case"add-item":case"remove-item":case"increment-item":case"decrement-item":{let{id:a,sku:o,path:i,priceVariantIdentifier:l="default",stock:u}=n;if(!o||!i)throw new Error(`Please provide "sku" and "path" for ${r}`);let c=t.clientBasket.cart.findIndex(f=>f.sku===o);if(c!==-1)if(r==="remove-item")t.clientBasket.cart.splice(c,1);else{let f=t.clientBasket.cart[c];r==="decrement-item"?f.quantity-=1:f.quantity+=1}else["remove-item","decrement-item"].includes(r)||t.clientBasket.cart.push({id:a,sku:o,path:i,priceVariantIdentifier:l,quantity:1,stock:u});t.status="server-basket-is-stale";break}case"set-server-basket":{t.serverBasket=n.serverBasket,t.status="ready",window.ENV.NEXT_PUBLIC_CRYSTALLIZE_TENANT_IDENTIFIER!=="furniture"&&window.ENV.SERVICE_API_URL==="https://remix-service-r44maju05-aleksep-gmailcom.vercel.app/api/graphql"&&(t.clientBasket.cart=t.serverBasket.cart.map(({id:a,sku:o,path:i,quantity:l,stock:u})=>({id:a,sku:o,path:i,quantity:l,priceVariantIdentifier:"default",stock:u})));break}case"draw-attention":{t.attentionCartItem={time:Date.now(),sku:n.sku};break}case"add-voucher":{t.clientBasket.voucherCode=n.voucherCode,t.status="server-basket-is-stale";break}case"remove-voucher":{t.clientBasket.voucherCode=S.clientBasket.voucherCode,t.status="server-basket-is-stale";break}default:throw new Error(`Action ${r} not supported`)}t.clientBasket.cart.length>0&&(t.clientBasket.cart=t.clientBasket.cart.filter(function({path:o,sku:i}){return o&&i})),t.totalQuantity=t.clientBasket.cart.reduce((a,o)=>a+o.quantity,0)});d();var me;typeof window!="undefined"&&"BroadcastChannel"in window&&(me=new BroadcastChannel("app_basket"));function ge(){return me}d();var Me=`
  query getServerBasket($basketModel: BasketModelInput!) {
    basket(basketModel: $basketModel) {
      total {
        gross
        net
        tax {
          name
          percent
        }
        currency
        discount
      }
      cart {
        sku
        name
        path
        quantity
        attributes {
          attribute
          value
        }
        price {
          gross
          currency
        }
        images {
          url
          variants {
            url
            width
            height
          }
        }
      }
    }
  }
`,be=Me;d();async function H({uri:e="https://product-storytelling-service-api.vercel.app/api/graphql",query:t,variables:r}){let n=JSON.stringify({query:t,variables:r}),a=await fetch(e,{method:"post",headers:{"content-type":"application/json"},body:n});if(!a.ok)throw new Error(await a.text());let o=await a.json();return o.errors&&console.error("Service API encountered an error",o.errors),o}var Oe=p.default.createContext(void 0),nt=()=>p.default.useContext(Oe);function ke({id:e,sku:t,path:r,quantity:n,priceVariantIdentifier:a,stock:o}){return{id:e,sku:t,path:r,quantity:n,priceVariantIdentifier:a,stock:o}}function at({locale:e,children:t}){let[{status:r,clientBasket:n,serverBasket:a,totalQuantity:o,changeTriggeredByOtherTab:i,attentionCartItem:l},u]=(0,p.useReducer)(ye,S),c=(0,p.useRef)(ge());(0,p.useEffect)(()=>{(async function(){let h=await ne();u({action:"hydrate",...h})})(),c.current&&(c.current.onmessage=function(s){u({action:"channel-update",...JSON.parse(s.data)})})},[]),(0,p.useEffect)(()=>{r!=="not-hydrated"&&ae({...n,cart:n.cart.map(ke)})},[r,n]),(0,p.useEffect)(()=>{var s;r==="ready"&&(i||(s=c.current)==null||s.postMessage(JSON.stringify({clientBasket:n,serverBasket:a})))},[r,n,a,i]);let f=(0,p.useMemo)(()=>({locale:e,cart:n.cart.map(ke),voucherCode:n.voucherCode,crystallizeOrderId:n.crystallizeOrderId,klarnaOrderId:n.klarnaOrderId}),[e,n]);(0,p.useEffect)(()=>{let s=!1;async function h(){try{let O=await H({query:be,variables:{basketModel:f}});!s&&O.data&&u({action:"set-server-basket",serverBasket:O.data.basket})}catch(O){console.log(O),u({action:"server-update-failed"})}}let A;return r==="server-basket-is-stale"&&(A=setTimeout(h,250)),()=>{s=!0,clearTimeout(A)}},[r,e.crystallizeCatalogueLanguage,f]);function g(s){return h=>u({action:s,...h})}function m(s){if(s.sku.startsWith("--voucher--"))return s;let h=n.cart.find(A=>A.sku===s.sku);return h?{...s,quantity:h.quantity}:null}let I=((a==null?void 0:a.cart)||[]).map(m).filter(Boolean);return r==="server-update-failed"?p.default.createElement("div",{style:{margin:"0 auto",maxWidth:400,padding:50}},"Oh-uh. Something went wrong when getting data from the Service API",p.default.createElement("br",null),p.default.createElement("br",null),p.default.createElement("button",{onClick:()=>u({action:"retry-server-update"})},"Try again")):p.default.createElement(Oe.Provider,{value:{status:r,basketModel:f,cart:I,total:(a==null?void 0:a.total)||{},totalQuantity:o,attentionCartItem:l,actions:{addVoucherCode:s=>u({action:"add-voucher",voucherCode:s}),removeVoucherCode:()=>u({action:"remove-voucher"}),empty:()=>u({action:"empty"}),addItem:g("add-item"),removeItem:g("remove-item"),incrementItem:g("increment-item"),decrementItem:g("decrement-item"),drawAttention:s=>u({action:"draw-attention",sku:s}),setCrystallizeOrderId:s=>u({action:"set-crystallize-order-id",crystallizeOrderId:s}),setKlarnaOrderId:s=>u({action:"set-klarna-order-id",klarnaOrderId:s})}}},t)}export{nt as a,at as b};
